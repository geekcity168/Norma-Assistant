<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome | Norma Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>
<body onload="checkPercentageChange()">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="assets/img/na-logo.png" alt="">
                Norma Assistant</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Contact</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                          Account
                        </a>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="login.html">Login</a></li>
                          <li><a class="dropdown-item" href="signup.html">Create Account</a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item" href="#">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-sm-12 col-md-4 mb-3">
                <div class="custom-container p-3">
                    <div class="profile-top">
                        <h5 class="display-8 m-3 text-uppercase text-secondary" >Profile Information</h5>
                        <div class="profile-cont m-3">
                            <img src="assets/img/pp.png" alt="">
                        </div>
                        <div id="userName" class="m-3 text-primary display-8 text-uppercase">
                            <!-- User name will be displayed here -->
                        </div>
                        <div class="m-3 display-8" id="userEmail">
                            <!-- User email will be displayed here -->
                        </div>
                        <div class="m-3 display-8" id="userCountry"></div>
                        <hr>
                        <div class="m-3 p-3 bottom-acc-profile">
                            <p class="mb-3">Connect to account</p>
                            <button type="button" class="btn btn-light mb-3" id="openBankButton">Add Bank</button>
                            <div id="bankLists">
                                <div class="p-3 mb-3 custom-div">
                                    <ul class="custom-list">
                                        <li id="bankName"></li>
                                        <li id="accountName"></li>
                                        <li id="accountNumber"></li>
                                        
                                    </ul>
                                </div>
                            </div>
                            <button type="button" class="btn btn-light mb-3" onclick="addMobileAccount()">Connect to Mobile</button>
                            <div id="bankLists">
                                <div class="p-3 mb-3 custom-div">
                                    <ul class="custom-list">
                                        <li id="mobileService"></li>
                                        <li id="mobileNumber"></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-12 col-md-4 mb-3 account-action">
                <div class="custom-container-img p-3">
                    <div class="inline-img-heading">
                        <img src="assets/img/na-logo-sm.png" alt="">
                    </div>
                    <h5 class="display-8 m-3 text-uppercase text-secondary inline-img-heading">Norma Account Monitor</h5>
                    <hr>
                    <div class="m-0 p-3 account-track">
                        <h3 class="m-1 fs-5 display-8">Balances</h3>
                        <div class="m-1 p-2 balances-cont">
                            <h3 class="m-1 fs-5 display-6">Outstanding Balance</h3>
                            <div class="mb-3  out-balance">
                                <div class="fs-4 display-8" id="accountBalance">Ksh.0</div>
                                <span id="percentChange">0%</span>
                            </div>
                            <h3 class="m-1 fs-5 display-6">Mobile Account Balance</h3>
                            <div class="mb-3  out-balance">
                                <div class="fs-7 display-8" id="mobBalance">Ksh.0</div>
                            </div>
                        </div>
                    </div>
                    <h3 class="m-3 fs-5 display-8">Transaction tracks</h3>
                    <div class="mt-3 mb-3 account-track receipts">
                        <div class="list-group" id="receiptsContainer">
                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-12 col-md-4 mb-3">
                <div class="custom-container p-3">
                    <div class="custom-container-img p-3">
                        <div class="inline-img-heading">
                            <img src="assets/img/na-planner.png" alt="">
                        </div>
                        <h5 class="display-8 m-3 text-secondary inline-img-heading">Norma Events Planner</h5>
                        <hr>
                        <p class="mb-3 text-left">Discover your planner list</p>
                        <button type="button" class="btn btn-outline-secondary mb-3">Create New Event</button>
                        <div class="m-1 p-3 events" id="eventsLists">
                            <div class="p-3 mb-3 custom-div event-list">
                                <ul class="custom-list">
                                    <li id="eventName">Event Name</li>
                                    <li id="startDate">01/02/2024</li>
                                    <li id="eventDes">Description goes here</li>
                                    <hr>
                                    <li>Allocated Amount : <span id="alcAmount">82892</span></li>
                                    <li>Duration: <span id="duration">3</span><span id="timeSpan">Months</span></li>
                                    <li>Days Left: <span id="daysLeft">25</span>Days</li>
                                </ul>
                            </div>
                        </div>
                        <div>
                            
                        </div>
                        <button type="button" class="btn btn-outline-warning m-3">Refresh Account</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!--
        Overlays and popup windows goes here...
    -->
    <!-- Add Bank details -->
    <div class="overlay-dark" id="bankPopupOverlay"></div>
    <div id="bankPopup" class="p-4">
        <h3 class="mb-3 fs-5 display-8">Add Bank Account</h3>
        <p>Link your Bank Card to Norma Assistant to help you track your account</p>
        <form>
            <div class="mb-3">
              <label for="bankSelect" class="form-label">Bank Account</label>
              <select class="form-select" aria-label="Default select example" id="bankSelect">
                <option selected value="">Select bank</option>
                <option value="KCB Bank">KCB Bank</option>
                <option value="Equity Bank">Equity Bank</option>
                <option value="Coperative Bank">Coperative Bank</option>
                <option value="Family Bank">Family Bank</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="accountnumber" class="form-label">Account Number</label>
              <input type="text" class="form-control" id="accountnumber" maxlength="24" oninput="formatAccountNumber(this)">
            </div>
            <div class="mb-3">
                <label for="expiry" class="form-label">Expiration Date</label>
                <input type="text" class="form-control" id="expiry" maxlength="5" oninput="formatExpiration(this)">
            </div>
            <div class="mb-3">
                <label for="cvc" class="form-label">CVC Code</label>
                <input type="number" class="form-control" id="cvc" maxlength="3" oninput="formatCVC(this)">
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="terms">
              <label class="form-check-label" for="terms">Agree to terms and conditions</label>
            </div>
            <div class="bottom-form-btn">
                <button type="submit" class="btn btn-primary" id="bankSubmit">Check Account</button>
                <div class="loading-circle"></div>
                <div class="fs-7 loading-status" id="loadStatus">Checking account...</div>
            </div>
          </form>
    </div>

    <!-- Add Mobile Account -->
    <div class="overlay-dark" id="addMobileOverlay"></div>
    <div class="p-4" id="mobilePopup">
        <h3 class="mb-3 fs-5 display-8">Add Mobile Money Account</h3>
        <form>
            <div class="mb-3">
                <label for="mobile-platform" class="form-label">Mobile money platform</label>
                <select id="mobile-platform" class="form-select">
                    <option value="MPESA">MPESA</option>
                    <option value="Airtel Money">Airtel Money</option>
                    <option value="T-Kash">T-Kash</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="mobile-phone">Mobile Phone Number</label>
                <input type="number" class="form-control" id="mobile-phone">
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="terms">
                <label class="form-check-label" for="terms">Agree to terms and conditions</label>
            </div>
            <div class="bottom-form-btn">
                <button type="submit" class="btn btn-primary" id="mobileSubmit">Check Account</button>
                <div class="loading-circle" id="mobileLoad"></div>
                <div class="fs-7 mt-3 loading-status" id="mobileLoadSatus">Checking mobile account...</div>
            </div>
        </form>
    </div>

    <!-- Status Bar -->

    <div class="p-3" id="statusBar">Status Message goes here...</div>

    <!-- JS links (jQuery and Bootstrap JS) -->
    <script src="js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
<script>
    var addMobileOverlay = document.getElementById("addMobileOverlay");
    var mobilePopup = document.getElementById("mobilePopup");

    function addMobileAccount() {
        addMobileOverlay.style.display = "block";
        mobilePopup.style.display = "block";

        var mobileSubmit = document.getElementById("mobileSubmit");
        mobileSubmit.addEventListener("click", function(event){
            event.preventDefault();
            console.log("Success");


            var mobilePlatform = document.getElementById("mobile-platform").value;
            var mobilePhone = document.getElementById("mobile-phone").value;

            if (mobilePhone.value == "") {
                alert("Please enter mobile number");
            }

            else {
                var mobileLoad = document.getElementById("mobileLoad");
                var mobileLoadSatus = document.getElementById("mobileLoadSatus");

                mobileLoad.style.display = "inline-block";
                mobileLoadSatus.style.display = "inline-block";

                    var formData = new FormData();
                    formData.append('mobilePlatform', mobilePlatform);
                    formData.append('mobilePhone', mobilePhone);

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "php/add_mobile_process.php", true);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            var response = xhr.responseText;
                            console.log("Server response:", response);
                            if (response.trim() === "success") {
                                statusBar.style.display = "block";
                                statusBar.innerHTML = "Account added successfully";
                                setTimeout(() => {
                                    mobileLoad.style.display = "none";
                                    mobileLoadSatus.style.display = "none";


                                    closeMobileWindow();
                                    window.location.reload();

                                    document.getElementById("mobileService").innerHTML = mobilePlatform.value;
                                    document.getElementById("mobileNumber").innerHTML = mobilePhone.value;

                                    statusBar.style.display = "block";
                                    statusBar.innerHTML = "Mobile Account added successfully";



                                    setInterval(() => {
                                        statusBar.style.display = "none";
                                    }, 3500);


                                    
                                }, 5600);
                            } else {
                                alert("An error occurred while adding the bank account. Please try again.");
                            }
                        }
                    };
                    xhr.send(formData);
                
            }
            
        });
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function getUserData() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "php/get_user_data.php", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var userData = JSON.parse(xhr.responseText);
                            document.getElementById("userName").textContent = userData.full_name;
                            document.getElementById("userEmail").textContent = userData.email;
                            document.getElementById("userCountry").textContent = userData.country;
                        } catch (e) {
                            console.error("Error parsing JSON: " + e.message);
                        }
                    } else {
                        console.error("Error fetching user data. Status code: " + xhr.status);
                    }
                }
            };
            xhr.send();
        }
        getUserData();
    });

    //Add Bank details

    function checkBankDetails() {
        var selectedBank = document.getElementById("bankSelect").value;
        var accountNumber = document.getElementById("accountnumber").value;
        var expirationDate = document.getElementById("expiry").value;
        var cvcCode = document.getElementById("cvc").value;

        // Create FormData object to send form data
        var formData = new FormData();
        formData.append('bankName', selectedBank);
        formData.append('accountNumber', accountNumber);
        formData.append('expirationDate', expirationDate);
        formData.append('cvcCode', cvcCode);

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "php/add_bank_process.php", true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var response = xhr.responseText;
                console.log("Server response:", response);
                if (response.trim() === "success") {
                    statusBar.style.display = "block";
                    statusBar.innerHTML = "Account added successfully";
                    bankName.innerHTML = selectedBank;
                    accountNumber.innerHTML = accountNumber;
                    setTimeout(() => {
                        statusBar.style.display = "none";
                        bankPopupOverlay.style.display = "none";
                        bankPopup.style.display = "none";
                    }, 3500);
                } else {
                    alert("An error occurred while adding the bank account. Please try again.");
                }
            }
        };
        xhr.send(formData);
    }
    function closeStatus() {
        statusBar.style.display = "none";
    }


    //Display bank details

    document.addEventListener("DOMContentLoaded", function() {
        displayBankDetails();
        displayMobileDetails();
        getAccountData();
    });

    function displayBankDetails() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "php/get_bank_details.php", true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                if (response.error) {
                    console.error(response.error);
                    alert("An error occurred while fetching bank details.");
                } else {
                    document.getElementById("bankName").textContent = response.bank_name;
                    document.getElementById("accountName").textContent = response.full_name;
                    document.getElementById("accountNumber").textContent = response.account_number;
                }
            }
        };
        xhr.send();
    }

    function displayMobileDetails() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "php/get_mobile_details.php", true);
        xhr.onreadystatechange = function() {
            if(xhr.readyState === 4 && xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                if(response.error) {
                    console.error(response.error);
                    alert("Error fetching mobile accounts");
                } else {
                    document.getElementById("mobileService").textContent = response.mobile_platform;
                    document.getElementById("mobileNumber").textContent = response.mobile_number;
                }
            }
        };
        xhr.send();
    }

    document.addEventListener('DOMContentLoaded', function() {

function getAccountData() {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "php/get_account_data.php", true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var accountData = JSON.parse(xhr.responseText);
                    document.getElementById("accountBalance").textContent = "Account Balance: Ksh." + accountData.account_balance;
                    fetchTransactionsAndUpdateReceipts(accountData);
                } catch (e) {
                    console.error("Error parsing JSON: " + e.message);
                }
            } else {
                console.error("Error fetching account data. Status code: " + xhr.status);
            }
        }
    };
    xhr.send();
}

function fetchTransactionsAndUpdateReceipts(accountData) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "php/get_transactions.php", true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            try {
                var transactions = JSON.parse(xhr.responseText);
                updateReceipts(transactions, accountData);
            } catch (e) {
                console.error("Error parsing JSON: " + e.message);
            }
        }
    };
    xhr.send();
}

function formatDate(date) {
    var day = date.getDate();
    var month = date.getMonth() + 1;
    var year = date.getFullYear();
    return (day < 10 ? '0' : '') + day + '/' + (month < 10 ? '0' : '') + month + '/' + year;
}

function calculatePercentageChange(transactionAmount, accountBalance) {
    return ((transactionAmount / accountBalance) * 100).toFixed(2);
}

function updateReceipts(transactions, accountData) {
    var receiptsContainer = document.getElementById("receiptsContainer");
    receiptsContainer.innerHTML = ""; // Clear previous receipts

    // Iterate through transactions and create receipts
    transactions.forEach(function(transaction) {
        var receipt = document.createElement("a");
        receipt.setAttribute("class", "list-group-item list-group-item-action");
        receipt.setAttribute("href", "#");
        var date = new Date(transaction.transaction_date); // Convert timestamp to milliseconds
        var dateString = formatDate(date);
        var timeString = date.toLocaleTimeString();
        var percentageChange = calculatePercentageChange(transaction.amount, accountData.account_balance);
        document.getElementById("percentChange").textContent = `${percentageChange}%`;
        receipt.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${transaction.transaction_type}</h6>
                <small>${dateString} ${timeString}</small>
            </div>
            <p class="mb-1">Transaction Code: ${transaction.transaction_code}</p>
            <small>Amount: Ksh.${transaction.amount}</small>
        `;
        receiptsContainer.appendChild(receipt);
    });
}

getAccountData();
});

    






</script>